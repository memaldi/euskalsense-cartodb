<html>
    <head>
        <meta charset="utf-8">
        <style>
          html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
          }
          #date_selector {
            position: absolute;
            top: 120px;
            right: 20px;
            padding: 0;
            width: 305px;
            }
          body {
            padding-top: 50px;
          }
          .starter-template {
            padding: 40px 15px;
            text-align: center;
          }
          #graph {
            position: absolute;
            top: 160px;
            right: 0px;
            padding: 0;
          }
          .axis path,
          .axis line {
            fill: none;
            stroke: white;
            shape-rendering: crispEdges;
          }

          .x.axis path {
            display: none;
          }
          .area {
            fill: dimgray;
            stroke-width: 0;
            opacity: 0.4;
          }
          .line {
            fill: none;
            stroke: dimgray;
            stroke-width: 2.5px;
          }
          text {
            font-size: 15px;
            stroke: silver;
          }
          div.tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: 28px;
            padding: 2px;
            font: 15px sans-serif;
            /*background: red;*/
            color: silver;
            border: 8px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.2;
          }
          div.cartodb-popup.v2 a.cartodb-popup-close-button:after, div.cartodb-popup.v2 a.cartodb-popup-close-button:before {
            background: red;
          }
        </style>
        <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <!--<link href="starter-template.css" rel="stylesheet">-->
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
        <title>EuskalSense</title>
    </head>
    </body>
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">EuskalSense</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </nav>

        <div id="map"></div>

        <div id="date_selector" class="cartodb-infobox">
          <div class="form-inline">
            <div class="form-group">
              <div class="input-group">
                <input type="datetime-local" class="form-control" id="datetime-picker" style="width: 233px;" >
              </div>
            </div>
            <button type="submit" class="btn btn-default" onclick="updateDate()">Check</button>
          </div>
          <form role="form">
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsTemperatura" value="t_c2_ba" checked onclick="onComponentSelect(value)">
                Temperatura
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsBenceno" value="benceno" onclick="onComponentSelect(value)">
                Benceno
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsViento" value="viento" onclick="onComponentSelect(value)">
                Viento
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsCH4" value="ch4" onclick="onComponentSelect(value)">
                CH4
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsCO" value="co" onclick="onComponentSelect(value)">
                CO
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsEtilbenceno" value="etilbenceno" onclick="onComponentSelect(value)">
                Etilbenceno
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsH" value="h" onclick="onComponentSelect(value)">
                H
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsHCNM" value="hcnm" onclick="onComponentSelect(value)">
                HCNM
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="optionsRadios" id="optionsMPXileno" value="mpxileno" onclick="onComponentSelect(value)">
                M-P-Xileno
              </label>
            </div>
          </form>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
        <script src="static/bootstrap/js/bootstrap.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript">

        var cartoDBLayer;
        var sql = new cartodb.SQL({ user: 'memaldi' });
        var layerIndexArray = ['t_c2_ba', 'benceno', 'viento', 'ch4', 'co', 'h', 'hcnm', 'mpxileno'];
        var unitsIndex = ['ÂºC'];

        var cartoCSS = {};
        cartoCSS['t_c2_ba'] = " \
        #t_c2_ba{ \
          marker-fill-opacity: 0.8; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-width: 10; \
          marker-fill: #FFFFB2; \
          marker-allow-overlap: true; \
        } \
        #t_c2_ba [ valor <= 40] { \
           marker-fill: #0079E5; \
        } \
        #t_c2_ba [ valor <= 35] { \
           marker-fill: #01C0E3; \
        } \
        #t_c2_ba [ valor <= 30] { \
           marker-fill: #03E2BE; \
        } \
        #t_c2_ba [ valor <= 25] { \
           marker-fill: #04E078; \
        } \
        #t_c2_ba [ valor <= 20] { \
           marker-fill: #06DF34; \
        } \
        #t_c2_ba [ valor <= 15] { \
           marker-fill: #1CDD07; \
        } \
        #t_c2_ba [ valor <= 10] { \
           marker-fill: #5FDC09; \
        } \
        #t_c2_ba [ valor <= 5] { \
           marker-fill: #A1DA0A; \
        } \
        #t_c2_ba [ valor <= 0] { \
           marker-fill: #D9D10B; \
        } \
        #t_c2_ba [ valor <= -5] { \
           marker-fill: #D7910D; \
        } \
        #t_c2_ba [ valor <= -10] { \
           marker-fill: #D6520E; \
        } \
        #t_c2_ba [ valor <= -15] { \
           marker-fill: #D51510; \
        }";

        cartoCSS['benceno'] = " \
        #benceno{ \
          marker-fill-opacity: 0.8; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-width: 10; \
          marker-fill: #229A00; \
          marker-allow-overlap: true; \
        } \
        #benceno [ valor >= 5] { \
           marker-fill: #d51510; \
        }";

        cartoCSS['viento'] = " \
        #v_vien{ \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/0kt.svg); \
          marker-fill-opacity: 0.9; \
          marker-line-color: #c0c0c0; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-allow-overlap: true; \
          marker-transform: rotate([dir], 0, 0); \
        } \
        #v_vien [fuerza >= 2.57] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/5kt.svg); \
        } \
        #v_vien [fuerza >= 5.14] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/10kt.svg); \
        } \
        #v_vien [fuerza >= 7.71] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/15kt.svg); \
        } \
        #v_vien [fuerza >= 10.28] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/20kt.svg); \
        } \
        #v_vien [fuerza >= 15.43] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/30kt.svg); \
        } \
        #v_vien [fuerza >= 20.57] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/40kt.svg); \
        } \
        #v_vien [fuerza >= 25.72] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/50kt.svg); \
        } \
        #v_vien [fuerza >= 38.58] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/75kt.svg); \
        } \
        #v_vien [fuerza >= 51.44] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/100kt.svg); \
        } \
        #v_vien [fuerza >= 64.30] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/125kt.svg); \
        } \
        #v_vien [fuerza >= 77.16] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/150kt.svg); \
        } \
        #v_vien [fuerza >= 90.02] { \
          marker-file: url(http://apps.morelab.deusto.es/euskalsense/static/img/175kt.svg); \
        }";

        cartoCSS['ch4'] = ' \
        #ch4{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FFFFFF; \
          marker-allow-overlap: true; \
        }';

        cartoCSS['co'] = ' \
        #co{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FFFFFF; \
          marker-allow-overlap: true; \
        }';

        cartoCSS['etilbenceno'] = ' \
        #etilbenceno{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FFFFFF; \
          marker-allow-overlap: true; \
        }';

        cartoCSS['h'] = ' \
        #h{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FF0000; \
          marker-allow-overlap: true; \
        } \
        #h [ valor <= 90] { \
           marker-fill: #FF1C1C; \
        } \
        #h [ valor <= 80] { \
           marker-fill: #FF3838; \
        } \
        #h [ valor <= 70] { \
           marker-fill: #FF5555; \
        } \
        #h [ valor <= 60] { \
           marker-fill: #FF7171; \
        } \
        #h [ valor <= 50] { \
           marker-fill: #FF8D8D; \
        } \
        #h [ valor <= 40] { \
           marker-fill: #FFAAAA; \
        } \
        #h [ valor <= 30] { \
           marker-fill: #FFC6C6; \
        } \
        #h [ valor <= 20] { \
           marker-fill: #FFE2E2; \
        } \
        #h [ valor <= 10] { \
           marker-fill: #FFFFFF; \
        }';

        cartoCSS['hcnm'] = ' \
        #hcnm{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FFFFFF; \
          marker-allow-overlap: true; \
        }';

        cartoCSS['mpxileno'] = ' \
        #mpxileno{ \
          marker-fill-opacity: 0.9; \
          marker-line-color: #FFF; \
          marker-line-width: 1.5; \
          marker-line-opacity: 1; \
          marker-placement: point; \
          marker-type: ellipse; \
          marker-width: 10; \
          marker-fill: #FFFFFF; \
          marker-allow-overlap: true; \
        }';

        var cartoLegend = {};
        cartoLegend['t_c2_ba'] = ' \
        <ul> \
          <li class="min"> \
            -20 \
          </li> \
          <li class="max"> \
            40 \
          </li> \
          <li class="graph count_441"> \
          <div class="colors"> \
          <div class="quartile" style="background-color:#0079E5"></div> \
          <div class="quartile" style="background-color:#01C0E3"></div> \
          <div class="quartile" style="background-color:#03E2BE"></div> \
          <div class="quartile" style="background-color:#04E078"></div> \
          <div class="quartile" style="background-color:#06DF34"></div> \
          <div class="quartile" style="background-color:#1CDD07"></div> \
          <div class="quartile" style="background-color:#5FDC09"></div> \
            <div class="quartile" style="background-color:#A1DA0A"></div> \
            <div class="quartile" style="background-color:#D9D10B"></div> \
            <div class="quartile" style="background-color:#D7910D"></div> \
            <div class="quartile" style="background-color:#D6520E"></div> \
            <div class="quartile" style="background-color:#D51510"></div> \
          </div> \
          </li> \
        </ul>';

        cartoLegend['benceno'] = ' \
        <ul> \
          <li class="min"> \
            0.0 \
          </li> \
          <li class="max"> \
            &gt;5 \
          </li> \
          <li class="graph count_126"> \
          <div class="colors"> \
          <div class="quartile" style="background-color:#229a00"></div> \
          <div class="quartile" style="background-color:#d51510"></div> \
          </div> \
          </li> \
        </ul>';

        cartoLegend['viento'] = '';

        cartoLegend['ch4'] = '';

        cartoLegend['co'] = '';

        cartoLegend['etilbenceno'] = '';

        cartoLegend['h'] = ' \
        <ul> \
          <li class="min"> \
            0 \
          </li> \
          <li class="max"> \
            100 % \
          </li> \
          <li class="graph count_441"> \
          <div class="colors"> \
          <div class="quartile" style="background-color:#FFFFFF"></div> \
          <div class="quartile" style="background-color:#FFE2E2"></div> \
          <div class="quartile" style="background-color:#FFC6C6"></div> \
          <div class="quartile" style="background-color:#FFAAAA"></div> \
          <div class="quartile" style="background-color:#FF8D8D"></div> \
          <div class="quartile" style="background-color:#FF7171"></div> \
          <div class="quartile" style="background-color:#FF5555"></div> \
            <div class="quartile" style="background-color:#FF3838"></div> \
            <div class="quartile" style="background-color:#FF1C1C"></div> \
            <div class="quartile" style="background-color:#FF0000"></div> \
          </div> \
          </li> \
        </ul>';

        cartoLegend['hcnm'] = '';

        cartoLegend['mpxileno'] = '';

        var cartoPopup = {};
        cartoPopup['t_c2_ba'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>Temperatura</h4> \
              <p style="color:black;">{{valor}} ÂºC</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['benceno'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>benceno</h4> \
              <p style="color:black;">{{valor}} &#181;g/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['ch4'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CH4</h4> \
              <p style="color:black;">{{valor}} mg/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['co'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CO</h4> \
              <p style="color:black;">{{valor}} &#181;g/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['etilbenceno'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CO</h4> \
              <p style="color:black;">{{valor}} &#181;g/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['h'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CO</h4> \
              <p style="color:black;">{{valor}} %</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['hcnm'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CO</h4> \
              <p style="color:black;">{{valor}} mg/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartoPopup['mpxileno'] = ' \
        <div class="cartodb-popup v2" style="background: dimgray; opacity: 0.9;"> \
          <a href="#close" class="cartodb-popup-close-button close" style="background: dimgray; opacity: 0.8;">x</a> \
          <div class="cartodb-popup-content-wrapper" > \
            <div class="cartodb-popup-content"> \
              <h4>EstaciÃ³n</h4> \
              <p style="color:black;">        {{nombre_estacion}}</p> \
              <p style="color:black;">{{direccion_estacion}}</p> \
              <p style="color:black;">{{localidad}}</p> \
              <h4>fecha</h4> \
              <p style="color:black;">{{fecha}}</p> \
              <h4>CO</h4> \
              <p style="color:black;">{{valor}} &#181;gg/m3</p> \
            </div> \
          </div> \
          <div class="cartodb-popup-tip-container"></div> \
        </div>';

        cartodb.createVis('map', 'http://memaldi.cartodb.com/api/v2/viz/81488756-8605-11e4-82d1-0e018d66dc29/viz.json')
        .done(function(vis, layers) {
          cartoDBLayer = layers[1];
          sql.execute("SELECT MAX(fecha) as maxFecha, MIN(fecha) as minFecha FROM (SELECT fecha FROM v_vien UNION ALL SELECT fecha FROM t_c2_ba) as subQuery")
            .done(function(data) {
              var max = data.rows[0].maxfecha;
              updateLayer(max, layerIndexArray[0], 0);
              var datetime = $("#datetime-picker");
              datetime.attr('value', String(max).replace('Z', ''));
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        });

        function onComponentSelect(value) {
          console.log(value);
          var date = $("#datetime-picker")[0].value;
          if (value != 'viento') {
            updateLayer(date, value, 0);
          } else {
            updateWindLayer(date, 0);
          }
        }

        function drawChart(date, station_name, layerIndex) {
          // Remove graph
          d3.select("svg")
            .remove();

          // D3JS graph
          var margin = {top: 20, right: 20, bottom: 30, left: 50},
          width = 350 - margin.left - margin.right,
          height = 182 - margin.top - margin.bottom;

          var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

          var x = d3.time.scale()
              .range([0, width]);

          var y = d3.scale.linear()
              .range([height, 0]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(d3.time.hour, 6)
              .orient("bottom")
              .tickFormat(d3.time.format("%H:%M"));;

          var yAxis = d3.svg.axis()
              .scale(y)
              .ticks(5)
              .orient("left");

          var area = d3.svg.area()
              .x(function(d) { return x(d.fecha); })
              .y0(height)
              .y1(function(d) { return y(d.valor); });

          var line = d3.svg.line()
              .x(function(d) { return x(d.fecha); })
              .y(function(d) { return y(d.valor); });

          var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          var svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("id", "graph")
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


          bottom_limit = date.split('T')[0] + "T00:00:00";
          top_limit =  date.split('T')[0] + "T23:00:00";
          sql.execute("SELECT fecha, valor FROM " + layerIndexArray[layerIndex] +" WHERE (fecha >= ('" + bottom_limit +  "') AND fecha <= ('" + top_limit + "') AND nombre_estacion = '" + station_name + "' AND valor IS NOT NULL) ORDER BY fecha ASC")
              .done(function(data) {
                var chartData = new Array()
                var valueAccum = 0;
                $.each(data['rows'], function(key, value) {
                  chartDate = parseDate(value.fecha.replace('Z', ''));
                  valueAccum =+ value.valor;
                  chartData.push({'fecha': chartDate, 'valor': valueAccum});
                });
                x.domain(d3.extent(chartData, function(d) { return d.fecha; }));
                y.domain([0, d3.max(chartData, function(d) { return d.valor; }) + 2]);

                svg.append("path")
                  .datum(chartData)
                  .attr("class", "area")
                  .attr("d", area);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                  .append("text")
                    //.attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "-10px")
                    .style("text-anchor", "end")
                    .text(unitsIndex[layerIndex]);
                svg.append("path")
                    .datum(chartData)
                    .attr("class", "line")
                    .attr("d", line);

                svg.selectAll("dot")
                  .data(chartData)
                  .enter()
                  .append("circle")
                  .attr("stroke", "dimgray")
                  .attr("stroke-width", 2.5)
                  .attr("fill", "black")
                  .attr("r", 4)
                  .attr("cx", function(d) { return x(d.fecha); })
                  .attr("cy", function(d) { return y(d.valor); })
                  .on("mouseover", function(d) {
                      div.transition()
                          .duration(200)
                          .style("opacity", 1);
                      div .html(d.valor)
                          .style("left", (d3.event.pageX - 28) + "px")
                          .style("top", (d3.event.pageY - 28) + "px");
                      })
                  .on("mouseout", function(d) {
                      div.transition()
                          .duration(500)
                          .style("opacity", 0);
                  });
              })
              .error(function(errors) {
                // errors contains a list of errors
                console.log("errors:" + errors);
          });
        }

        function updateLayer(date, table_name, sublayer_number) {

          var subLayerOptions = {
                sql: "SELECT * FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)",
                cartocss: cartoCSS[table_name]
              }
          cartoDBLayer.getSubLayer(sublayer_number)
                      .set(subLayerOptions)
                      .on('featureClick', function(event, latlng, pos, data, layerIndex) {
                        sql.execute("SELECT fecha, nombre_estacion FROM " + table_name + " WHERE cartodb_id = " + data.cartodb_id)
                            .done(function(data) {
                              var fecha = data.rows[0].fecha;
                              var nombre_estacion = data.rows[0].nombre_estacion;
                              drawChart(fecha, nombre_estacion, layerIndex);
                            })
                            .error(function(errors) {
                              // errors contains a list of errors
                              console.log("errors:" + errors);
                        });
                      }).infowindow.set('template', cartoPopup[table_name]);
          var legend = $(".cartodb-legend.choropleth")[0];
          legend.innerHTML = cartoLegend[table_name];
        }

        function updateWindLayer(date, sublayer_number) {
          var subLayerOptions = {
                sql: "SELECT v_vien.fecha, v_vien.the_geom_webmercator, v_vien.cartodb_id, v_vien.nombre_estacion, v_vien.valor as fuerza, d_vien.valor as dir, v_vien.localidad, v_vien.direccion_estacion FROM v_vien, d_vien WHERE (v_vien.fecha >= ('" + date + "') AND v_vien.fecha <= ('" + date + "') AND v_vien.valor is not Null AND v_vien.fecha = d_vien.fecha AND v_vien.nombre_estacion = d_vien.nombre_estacion)",
                cartocss: cartoCSS['viento']
              }
          cartoDBLayer.getSubLayer(sublayer_number)
                      .set(subLayerOptions)
                      .on('featureClick', function(event, latlng, pos, data, layerIndex) {
                        sql.execute("SELECT fecha, nombre_estacion FROM v_vien WHERE cartodb_id = " + data.cartodb_id)
                            .done(function(data) {
                              var fecha = data.rows[0].fecha;
                              var nombre_estacion = data.rows[0].nombre_estacion;
                              drawChart(fecha, nombre_estacion, layerIndex);
                            })
                            .error(function(errors) {
                              // errors contains a list of errors
                              console.log("errors:" + errors);
                        });
                      });
          var legend = $(".cartodb-legend.choropleth")[0];
          legend.innerHTML = cartoLegend['viento'];
        }

        function updateDate() {
          // Remove graph
          d3.select("svg")
            .remove();

          var date = $("#datetime-picker")[0].value;
          var windRadioButton = $("#optionsViento")[0];
          if (windRadioButton.checked) {
            updateWindLayer(date, 0);
          } else {
            var radioButtons = $("input[name='optionsRadios']");
            $.each(radioButtons, function (index, item) {
              if (item.checked) {
                updateLayer(date, item.value, 0);
                return false;
              }
            });

          }
        }

        </script>

    </body>
</html>