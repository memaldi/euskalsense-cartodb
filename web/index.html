<html>
    <head>
        <style>
          html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
          }
          #date_selector {
            position: absolute;
            top: 120px;
            right: 20px;
            padding: 0;
            width: 305px;
            }
          body {
            padding-top: 50px;
          }
          .starter-template {
            padding: 40px 15px;
            text-align: center;
          }

        </style>
        <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <!--<link href="starter-template.css" rel="stylesheet">-->
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
        <title>EuskalSense</title>
    </head>
    </body>
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">EuskalSense</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </nav>

        <div id="map"></div>

        <div id="date_selector" class="cartodb-infobox">
          <div class="form-inline">
            <div class="form-group">
              <div class="input-group">
                <input type="datetime-local" class="form-control" id="datetime-picker" style="width: 233px;" >
              </div>
            </div>
            <button type="submit" class="btn btn-default" onclick="updateDate()">Check</button>
          </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
        <script src="static/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript">

        var cartoDBLayer;
        var sql = new cartodb.SQL({ user: 'memaldi' });

        cartodb.createVis('map', 'http://memaldi.cartodb.com/api/v2/viz/95288572-73f0-11e4-bcc3-0e018d66dc29/viz.json')
        .done(function(vis, layers) {
          cartoDBLayer = layers[1];
          sql.execute("SELECT MAX(fecha) as maxFecha, MIN(fecha) as minFecha FROM (SELECT fecha FROM v_vien UNION ALL SELECT fecha FROM t_c2_ba) as subQuery")
            .done(function(data) {
              var max = data.rows[0].maxfecha;
              updateLayer(max, "v_vien", 0);
              updateLayer(max, "t_c2_ba", 1);
              var datetime = $("#datetime-picker");
              console.log(String(max));
              console.log(String(max).replace('Z', ''));
              datetime.attr('value', String(max).replace('Z', ''));
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        });

        function updateLayer(date, table_name, sublayer_number) {

          sql.execute("SELECT MAX(valor), MIN(valor) FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)")
            .done(function(data) {
              var subLayerOptions = {
                sql: "SELECT * FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)"
                //cartocss: cartoCSS
              }
              cartoDBLayer.getSubLayer(sublayer_number).set(subLayerOptions);
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        }

        function updateDate() {
          var date = $("#datetime-picker")[0].value;

          updateLayer(date, "v_vien", 0);
          updateLayer(date, "t_c2_ba", 1);
        }

        </script>

    </body>
</html>