<html>
    <head>
        <meta charset="utf-8">
        <style>
          html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
          }
          #date_selector {
            position: absolute;
            top: 120px;
            right: 20px;
            padding: 0;
            width: 305px;
            }
          body {
            padding-top: 50px;
          }
          .starter-template {
            padding: 40px 15px;
            text-align: center;
          }
          #graph {
            position: absolute;
            top: 160px;
            right: 0px;
            padding: 0;
          }
          .axis path,
          .axis line {
            fill: none;
            stroke: white;
            shape-rendering: crispEdges;
          }

          .x.axis path {
            display: none;
          }
          .area {
            fill: dimgray;
            stroke-width: 0;
            opacity: 0.4;
          }
          .line {
            fill: none;
            stroke: dimgray;
            stroke-width: 2.5px;
          }
          text {
            font-size: 15px;
            stroke: silver;
          }
          div.tooltip {
            position: absolute;
            text-align: center;
            width: 60px;
            height: 28px;
            padding: 2px;
            font: 15px sans-serif;
            /*background: red;*/
            color: silver;
            border: 8px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0.2;
          }
          div.cartodb-popup.v2 a.cartodb-popup-close-button:after, div.cartodb-popup.v2 a.cartodb-popup-close-button:before {
            background: red;
          }
        </style>
        <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <!--<link href="starter-template.css" rel="stylesheet">-->
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
        <title>EuskalSense</title>
    </head>
    </body>
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">EuskalSense</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </nav>

        <div id="map"></div>

        <div id="date_selector" class="cartodb-infobox">
          <div class="form-inline">
            <div class="form-group">
              <div class="input-group">
                <input type="datetime-local" class="form-control" id="datetime-picker" style="width: 233px;" >
              </div>
            </div>
            <button type="submit" class="btn btn-default" onclick="updateDate()">Check</button>
          </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
        <script src="static/bootstrap/js/bootstrap.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript">

        var cartoDBLayer;
        var sql = new cartodb.SQL({ user: 'memaldi' });
        var layerIndexArray = ['v_vien', 't_c2_ba', 'benceno', 'ch4'];
        var unitsIndex = ['m/s', 'ÂºC'];

        cartodb.createVis('map', 'http://memaldi.cartodb.com/api/v2/viz/95288572-73f0-11e4-bcc3-0e018d66dc29/viz.json')
        .done(function(vis, layers) {
          cartoDBLayer = layers[1];
          sql.execute("SELECT MAX(fecha) as maxFecha, MIN(fecha) as minFecha FROM (SELECT fecha FROM v_vien UNION ALL SELECT fecha FROM t_c2_ba) as subQuery")
            .done(function(data) {
              var max = data.rows[0].maxfecha;
              for (i = 0; i < layerIndexArray.length; i++) {
                    if (i == 0) {
                      updateWindLayer(max, layerIndexArray[i], i);
                    } else {
                      updateLayer(max, layerIndexArray[i], i);
                    }
              }
              //updateWindLayer(max, "v_vien", 0);
              //updateLayer(max, "t_c2_ba", 1);
              var datetime = $("#datetime-picker");
              datetime.attr('value', String(max).replace('Z', ''));
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        });


        function drawChart(date, station_name, layerIndex) {
          // Remove graph
          d3.select("svg")
            .remove();

          // D3JS graph
          var margin = {top: 20, right: 20, bottom: 30, left: 50},
          width = 350 - margin.left - margin.right,
          height = 182 - margin.top - margin.bottom;

          var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

          var x = d3.time.scale()
              .range([0, width]);

          var y = d3.scale.linear()
              .range([height, 0]);

          var xAxis = d3.svg.axis()
              .scale(x)
              .ticks(d3.time.hour, 6)
              .orient("bottom")
              .tickFormat(d3.time.format("%H:%M"));;

          var yAxis = d3.svg.axis()
              .scale(y)
              .ticks(5)
              .orient("left");

          var area = d3.svg.area()
              .x(function(d) { return x(d.fecha); })
              .y0(height)
              .y1(function(d) { return y(d.valor); });

          var line = d3.svg.line()
              .x(function(d) { return x(d.fecha); })
              .y(function(d) { return y(d.valor); });

          var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

          var svg = d3.select("body").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .attr("id", "graph")
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");


          bottom_limit = date.split('T')[0] + "T00:00:00";
          top_limit =  date.split('T')[0] + "T23:00:00";
          sql.execute("SELECT fecha, valor FROM " + layerIndexArray[layerIndex] +" WHERE (fecha >= ('" + bottom_limit +  "') AND fecha <= ('" + top_limit + "') AND nombre_estacion = '" + station_name + "' AND valor IS NOT NULL) ORDER BY fecha ASC")
              .done(function(data) {
                var chartData = new Array()
                var valueAccum = 0;
                $.each(data['rows'], function(key, value) {
                  chartDate = parseDate(value.fecha.replace('Z', ''));
                  valueAccum =+ value.valor;
                  chartData.push({'fecha': chartDate, 'valor': valueAccum});
                });
                x.domain(d3.extent(chartData, function(d) { return d.fecha; }));
                y.domain([0, d3.max(chartData, function(d) { return d.valor; }) + 2]);

                svg.append("path")
                  .datum(chartData)
                  .attr("class", "area")
                  .attr("d", area);

                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis);

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                  .append("text")
                    //.attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", "-10px")
                    .style("text-anchor", "end")
                    .text(unitsIndex[layerIndex]);
                svg.append("path")
                    .datum(chartData)
                    .attr("class", "line")
                    .attr("d", line);

                svg.selectAll("dot")
                  .data(chartData)
                  .enter()
                  .append("circle")
                  .attr("stroke", "dimgray")
                  .attr("stroke-width", 2.5)
                  .attr("fill", "black")
                  .attr("r", 4)
                  .attr("cx", function(d) { return x(d.fecha); })
                  .attr("cy", function(d) { return y(d.valor); })
                  .on("mouseover", function(d) {
                      div.transition()
                          .duration(200)
                          .style("opacity", 1);
                      div .html(d.valor)
                          .style("left", (d3.event.pageX - 28) + "px")
                          .style("top", (d3.event.pageY - 28) + "px");
                      })
                  .on("mouseout", function(d) {
                      div.transition()
                          .duration(500)
                          .style("opacity", 0);
                  });
              })
              .error(function(errors) {
                // errors contains a list of errors
                console.log("errors:" + errors);
          });
        }

        function updateLayer(date, table_name, sublayer_number) {

          var subLayerOptions = {
                sql: "SELECT * FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)"
                //cartocss: cartoCSS
              }
              cartoDBLayer.getSubLayer(sublayer_number)
                          .set(subLayerOptions)
                          .on('featureClick', function(event, latlng, pos, data, layerIndex) {
                            sql.execute("SELECT fecha, nombre_estacion FROM " + layerIndexArray[layerIndex] + " WHERE cartodb_id = " + data.cartodb_id)
                                .done(function(data) {
                                  var fecha = data.rows[0].fecha;
                                  var nombre_estacion = data.rows[0].nombre_estacion;
                                  drawChart(fecha, nombre_estacion, layerIndex);
                                })
                                .error(function(errors) {
                                  // errors contains a list of errors
                                  console.log("errors:" + errors);
                            });
                          });
        }

        function updateWindLayer(date, table_name, sublayer_number) {
          var subLayerOptions = {
                sql: "SELECT v_vien.fecha, v_vien.the_geom_webmercator, v_vien.cartodb_id, v_vien.nombre_estacion, v_vien.valor as fuerza, d_vien.valor as dir, v_vien.localidad, v_vien.direccion_estacion FROM v_vien, d_vien WHERE (v_vien.fecha >= ('" + date + "') AND v_vien.fecha <= ('" + date + "') AND v_vien.valor is not Null AND v_vien.fecha = d_vien.fecha AND v_vien.nombre_estacion = d_vien.nombre_estacion)"
              }
          cartoDBLayer.getSubLayer(sublayer_number)
                      .set(subLayerOptions)
                      .on('featureClick', function(event, latlng, pos, data, layerIndex) {
                        sql.execute("SELECT fecha, nombre_estacion FROM " + layerIndexArray[layerIndex] + " WHERE cartodb_id = " + data.cartodb_id)
                            .done(function(data) {
                              var fecha = data.rows[0].fecha;
                              var nombre_estacion = data.rows[0].nombre_estacion;
                              drawChart(fecha, nombre_estacion, layerIndex);
                            })
                            .error(function(errors) {
                              // errors contains a list of errors
                              console.log("errors:" + errors);
                        });
                      });
        }

        function updateDate() {
          // Remove graph
          d3.select("svg")
            .remove();

          var date = $("#datetime-picker")[0].value;

          for (i = 0; i < layerIndexArray.length; i++) {
            if (i == 0) {
              updateWindLayer(date, layerIndexArray[i], i);
            } else {
              updateLayer(date, layerIndexArray[i], i);
            }
          }

          //updateWindLayer(date, "v_vien", 0);
          //updateLayer(date, "t_c2_ba", 1);
        }

        </script>

    </body>
</html>