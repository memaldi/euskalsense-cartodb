<html>
    <head>
        <style>
          html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
          }
          #date_selector {
            position: absolute;
            top: 120px;
            right: 20px;
            padding: 0;
            width: 305px;
            }
          body {
            padding-top: 50px;
          }
          .starter-template {
            padding: 40px 15px;
            text-align: center;
          }
          .axis path,
          .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
          }

          .x.axis path {
            display: none;
          }

          .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 1.5px;
          }
        </style>
        <link href="static/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <!-- Custom styles for this template -->
        <!--<link href="starter-template.css" rel="stylesheet">-->
        <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css" />
        <title>EuskalSense</title>
    </head>
    </body>
        <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="#">EuskalSense</a>
            </div>
            <div id="navbar" class="collapse navbar-collapse">
              <ul class="nav navbar-nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </nav>

        <div id="map"></div>

        <div id="date_selector" class="cartodb-infobox">
          <div class="form-inline">
            <div class="form-group">
              <div class="input-group">
                <input type="datetime-local" class="form-control" id="datetime-picker" style="width: 233px;" >
              </div>
            </div>
            <button type="submit" class="btn btn-default" onclick="updateDate()">Check</button>
          </div>
        </div>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script src="http://libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.js"></script>
        <script src="static/bootstrap/js/bootstrap.min.js"></script>
        <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
        <script type="text/javascript">

        var cartoDBLayer;
        var sql = new cartodb.SQL({ user: 'memaldi' });

        cartodb.createVis('map', 'http://memaldi.cartodb.com/api/v2/viz/95288572-73f0-11e4-bcc3-0e018d66dc29/viz.json')
        .done(function(vis, layers) {
          cartoDBLayer = layers[1];
          sql.execute("SELECT MAX(fecha) as maxFecha, MIN(fecha) as minFecha FROM (SELECT fecha FROM v_vien UNION ALL SELECT fecha FROM t_c2_ba) as subQuery")
            .done(function(data) {
              var max = data.rows[0].maxfecha;
              updateLayer(max, "v_vien", 0);
              updateLayer(max, "t_c2_ba", 1);
              var datetime = $("#datetime-picker");
              datetime.attr('value', String(max).replace('Z', ''));


              // D3JS graph
              var margin = {top: 20, right: 20, bottom: 30, left: 50},
              width = 960 - margin.left - margin.right,
              height = 500 - margin.top - margin.bottom;

              var parseDate = d3.time.format("%Y-%m-%dT%H:%M:%S").parse;

              var x = d3.time.scale()
                  .range([0, width]);

              var y = d3.scale.linear()
                  .range([height, 0]);

              var xAxis = d3.svg.axis()
                  .scale(x)
                  .orient("bottom");

              var yAxis = d3.svg.axis()
                  .scale(y)
                  .orient("left");

              var line = d3.svg.line()
                  .x(function(d) { return x(d.fecha); })
                  .y(function(d) { return y(d.valor); });

              var svg = d3.select("body").append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

              bottom_limit = max.split('T')[0] + "T00:00:00";
              top_limit =  max.split('T')[0] + "T23:00:00";
              sql.execute("SELECT fecha, valor FROM t_c2_ba WHERE (fecha >= ('" + bottom_limit +  "') AND fecha <= ('" + top_limit + "') AND nombre_estacion = 'ABANTO' AND valor IS NOT NULL) ORDER BY fecha ASC")
                  .done(function(data) {
                    var graphData = new Array()
                    var valueAccum = 0;
                    $.each(data['rows'], function(key, value) {
                      graphDate = parseDate(value.fecha.replace('Z', ''));
                      valueAccum =+ value.valor;
                      graphData.push({'fecha': graphDate, 'valor': valueAccum});
                    });
                    x.domain(d3.extent(graphData, function(d) { return d.fecha; }));
                    y.domain([0, d3.max(graphData, function(d) { return d.valor; }) + 2]);

                    svg.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + height + ")")
                        .call(xAxis);

                    svg.append("g")
                        .attr("class", "y axis")
                        .call(yAxis)
                      .append("text")
                        .attr("transform", "rotate(-90)")
                        .attr("y", 6)
                        .attr("dy", ".71em")
                        .style("text-anchor", "end")
                        .text("Price ($)");
                    svg.append("path")
                        .datum(graphData)
                        .attr("class", "line")
                        .attr("d", line);
                  })
                  .error(function(errors) {
                    // errors contains a list of errors
                    console.log("errors:" + errors);
              });
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        });

        function updateLayer(date, table_name, sublayer_number) {

          sql.execute("SELECT MAX(valor), MIN(valor) FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)")
            .done(function(data) {
              var subLayerOptions = {
                sql: "SELECT * FROM " + table_name + " WHERE (fecha >= ('" + date +  "') AND fecha <= ('" + date + "') AND valor IS NOT NULL)"
                //cartocss: cartoCSS
              }
              cartoDBLayer.getSubLayer(sublayer_number).set(subLayerOptions);
            })
            .error(function(errors) {
              // errors contains a list of errors
              console.log("errors:" + errors);
          });
        }

        function updateDate() {
          var date = $("#datetime-picker")[0].value;

          updateLayer(date, "v_vien", 0);
          updateLayer(date, "t_c2_ba", 1);
        }

        </script>

    </body>
</html>